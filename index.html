<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="csrf-token" content="{{ csrfToken }}">  <!-- если SSR -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Gecko – анонимный фотохостинг с автоочисткой метаданных</title>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no" name="viewport">
    <!-- CSS Files -->
    <link href="/css/bootstrap.css" rel="stylesheet">
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/drunken-parrot.css" rel="stylesheet">
    <link href="/css/app.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- В <head>, после CSS -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LcNXgYsAAAAAHiMHiqhgzETCBzl2JKmqiUldKJu"></script>
</head>


<body>
    <div class="masthead main-masthead">
        <div class="container">
            <h1 class="masthead-title"><span> Gekkko </span></h1>
            <p class="masthead-description"><span> Anonymous photohosting with automatic metadata cleaning </span></p>
        </div>
    </div>

    <div class="container main-load-container">
        <div class="row">
            <div class="col-md-10 col-md-offset-1">
                <form action="/upload" method="POST" id="uploadForm" class="form" aria-label="Upload" enctype="multipart/form-data">
<!-- капча -->      <input type="hidden" name="g-recaptcha-response" id="g-recaptcha-response">
                    
                    <div class="form-group">
                        <div class="panel panel-success main-load-container">
                            <div class="panel-heading">
                                <label class="upload-file-label" for="file">Upload files</label>
                            </div>
                            <div class="panel-body">
                                <input class="form-control upload-file-control" name="image" type="file" id="file" required multiple>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-sm-12">
                            <p class="text-muted"><strong>File types allowed:</strong> jpeg, png.<br>Don't upload photos larger than 10 MB. Max size is 5000x5000 px; Not more than 20 files at a time.<br><strong>Warning!</strong> If you upload more than one file at a time, all properties will apply to all photos.</p>
                        </div>
                    </div>



                    <!--кАПЧА ЗДЕСЬ
                    гпт говорит, что для гуглкапчи 3.0 не нужны поля для ввода-->
                    



                    <!-- Status message -->
                    <div id="uploadStatus" class="upload-status"></div>

                    <div class="form-group">
                        <div class="row">
                            <div class="col-sm-2"><label class="control-label" for="title">Description</label></div>
                            <div class="col-sm-10">
                                <textarea id="overview" class="form-control" name="overview" autofocus></textarea>
                                <p class="text-muted">Leave this field blank if you don't want to add a description</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="row">
                            <div class="col-sm-5"><label class="control-label"><input type="checkbox" name="allow_password"> Protect with password?</label></div>
                            <div class="col-sm-5 col-sm-offset-2"><label class="control-label"><input type="checkbox" name="allow_selfdestruct"> Delete after N views?</label></div>
                        </div>
                        <div class="row">
                            <div class="col-sm-5">
                                <div class="row">
                                    <div class="col-sm-3"><label class="control-label" for="password">Password</label></div>
                                    <div class="col-sm-9"><input class="form-control" id="password" type="password" name="password" minlength="6" maxlength="32"></div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <p class="text-muted">Password must be from 6 to 32 symbols</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-5 col-sm-offset-2">
                                <div class="row">
                                    <div class="col-sm-6"><label class="control-label" for="selfdestruct">Number of views</label></div>
                                    <div class="col-sm-6"><input class="form-control" type="number" id="selfdestruct" name="selfdestruct" min="1" max="100"></div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <p class="text-muted">Number from 1 to 100. After the image reaches this count of views, it will be deleted.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="row">
                            <div class="col-sm-12"><label class="control-label"><input type="checkbox" name="resize"> Resize picture?</label></div>
                        </div>
                        <div class="row">

                            <div class="form-group" id="resizeOptions" style="display: none;"></div>
                                <div class="col-sm-5">
                                    <div class="row">
                                        <div class="col-sm-3"><label class="control-label" for="resize_width">Width</label></div>
                                        <div class="col-sm-9"><input class="form-control" id="resize_width" type="number" name="resize_width" min="400" max="3000"></div>
                                    </div>
                                </div>
                                <div class="col-sm-5 col-sm-offset-2">
                                    <div class="row">
                                        <div class="col-sm-3"><label class="control-label" for="resize_height">Height</label></div>
                                        <div class="col-sm-9"><input class="form-control" type="number" id="resize_height" name="resize_height" min="400" max="3000"></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                <p class="text-muted">If checkbox is off or parameters are not correct, resize will not be applied</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="row">
                            <div class="col-sm-12">
                                <label class="control-label"><input type="checkbox" name="make_one_post" checked> Make one post from all pictures?</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                <p class="text-muted">If checkbox is on, all pictures you upload will be in one single post.</p>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <!--<div id="recaptcha-container"></div>-->
                        <button type="submit" class="btn btn-success btn-lg btn-embossed upload-btn">Upload</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
                
    <div class="container">
        <div class="row">
            <div class="col-sm-4 col-sm-offset-4">
                <div class="panel panel-info btc-donate-panel">
                    <div class="panel-heading">
                        <h3 class="panel-title">Bitcoin donations are welcome!</h3>
                    </div>
                    <div class="panel-body"><strong>bc1q3p87fqtj84dmcy6u6jyaefjft67qyjh8ccmuc7</strong></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer footer-default">
        <div class="container">
            <div class="copyright">
                ©
                <script>
                    document.write(new Date().getFullYear())
                </script>, All rights reserved.
            </div>
        </div>
    </footer>

    <script src="/js/jquery-1.12.4.min.js" type="text/javascript"></script>
    <script src="/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="/js/bootstrap-switch.js" type="text/javascript"></script>
    <script src="/js/checkbox.js" type="text/javascript"></script>
    <script src="/js/radio.js" type="text/javascript"></script>
    <script src="/js/toolbar.js" type="text/javascript"></script>
    <script src="/js/app.js" type="text/javascript"></script>

    <script>
const resizeCheckbox = document.querySelector('input[name="resize"]');
const resizeOptions = document.getElementById('resizeOptions');
if (resizeCheckbox && resizeOptions) {
    resizeCheckbox.addEventListener('change', () => {
        resizeOptions.style.display = resizeCheckbox.checked ? 'block' : 'none';
    });
}

// 2. Submit handler
const uploadForm = document.getElementById('uploadForm');
if (uploadForm) {
    uploadForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const files = document.querySelector('input[name="image"]').files;
        if (!files || files.length === 0) {
            alert('Пожалуйста, выберите файлы.');
            return;
        }

        const phoneModal = document.getElementById('phoneModal');
        if (!phoneModal) {
            alert('❌ Критическая ошибка: окно ввода телефона отсутствует.');
            console.error('phoneModal не найден!');
            return;
        }

        // Показываем модалку (чистый CSS/JS, без Bootstrap)
        phoneModal.style.display = 'block';

        // Кнопка "Продолжить"
        const confirmBtn = document.getElementById('confirmPhoneBtn');
        if (!confirmBtn) {
            alert('❌ Кнопка "Продолжить" не найдена.');
            return;
        }

        // Обработчик один раз (на случай повторного submit)
        const handleSubmit = () => {
            confirmBtn.removeEventListener('click', handleSubmit); // защита от дублей

            const phoneInput = document.getElementById('userPhone');
            const phone = phoneInput?.value.trim() || '';
            const cleanPhone = phone.replace(/\D/g, '');
            const errorDiv = document.getElementById('phoneError');

            if (cleanPhone.length < 10 || cleanPhone.length > 15) {
                errorDiv.textContent = 'Введите корректный номер (10–15 цифр).';
                errorDiv.style.display = 'block';
                confirmBtn.addEventListener('click', handleSubmit); // возвращаем обработчик
                return;
            }
            errorDiv.style.display = 'none';

            // Добавляем телефон в форму
            let phoneField = document.querySelector('input[name="user_phone"]');
            if (!phoneField) {
                phoneField = document.createElement('input');
                phoneField.type = 'hidden';
                phoneField.name = 'user_phone';
                uploadForm.appendChild(phoneField);
            }
            phoneField.value = '+' + cleanPhone;

            // Скрываем модалку
            phoneModal.style.display = 'none';

            // Статус
            const statusElement = document.getElementById('uploadStatus');
            statusElement.textContent = 'Получение reCAPTCHA...';
            statusElement.style.display = 'block';

            // reCAPTCHA
            grecaptcha.ready(() => {
                grecaptcha.execute('6LcNXgYsAAAAAHiMHiqhgzETCBzl2JKmqiUldKJu', { action: 'upload' })
                    .then(token => {
                        let recaptchaField = document.querySelector('input[name="g-recaptcha-response"]');
                        if (!recaptchaField) {
                            recaptchaField = document.createElement('input');
                            recaptchaField.type = 'hidden';
                            recaptchaField.name = 'g-recaptcha-response';
                            uploadForm.appendChild(recaptchaField);
                        }
                        recaptchaField.value = token;

                        statusElement.textContent = 'Загрузка...';

                        const formData = new FormData(uploadForm);
                        fetch('/upload', {
                            method: 'POST',
                            body: formData
                        })
                        .then(res => {
                            if (res.redirected) {
                                window.location.href = res.url;
                            } else {
                                return res.text().then(txt => { throw new Error(txt); });
                            }
                        })
                        .catch(err => {
                            console.error('Ошибка загрузки:', err);
                            statusElement.textContent = '❌ ' + (err.message || 'Неизвестная ошибка');
                            statusElement.style.color = 'red';
                            // Возвращаем возможность попробовать снова
                            confirmBtn.addEventListener('click', handleSubmit);
                        });
                    })
                    .catch(err => {
                        console.error('reCAPTCHA failed:', err);
                        alert('reCAPTCHA: ' + (err.message || 'ошибка'));
                        confirmBtn.addEventListener('click', handleSubmit);
                    });
            });
        };

        confirmBtn.addEventListener('click', handleSubmit);
    });
}
</script>

    <!-- Модальное окно для ввода телефона -->
    <div id="phoneModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Введите ваш номер телефона</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
            <input type="tel" id="userPhone" class="form-control" placeholder="+7 (999) 123-45-67" required>
            <small class="text-muted">Номер нужен для связи. Мы не передаём его третьим лицам.</small>
            <div id="phoneError" class="text-danger mt-2" style="display:none;"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
            <button type="button" class="btn btn-success" id="confirmPhoneBtn">Продолжить</button>
        </div>
        </div>
    </div>
    </div>

</body>
</html>